# e-Shop 서비스의 멀티테넌시 요구사항

여러 조직에서 자체 조직의 e-Shop 을 멀티태넌시로 나누어 사용하고 싶은 경우 가능한 자원을 공유하여 사용할 수 있는 방법으로 싱글인스턴스-멀티테넌시가 있다. 테넌트 별로 Dedicate 한 자원을 제공하지 않고 공유된 자원을 사용하므로써 신규 테넌트 유입에 대한 부담이 적어 Free-tier 및 Evaluation  기간 등을 제공하기에 부담이 없는 아키텍처이다.


# 메타웍스4 의 멀티테넌시 프레임워크 기능

메타웍스4의 멀티테넌시 기능을 적용하여 데이터베이스와 파일 등의 저장공간을 분리하고 커스터마이징 기능을 제공 받을 수 있다:

1. JWT 토큰과 OAuth2.0을 통한 테넌트 식별 (이를 위하여 OCE IAM 서버와 같이 적용해야 함)
1. 데이터베이스의 컬럼 기반 테넌트 데이터 분리 저장 / 추출
1. 파일 시스템의 접속 테넌트 별 저장 / 추출
1. 메타데이터 설정 및 분산 노드 반영
1. 메타데이터 설정 셀프서비스 UI
1. 메타데이터 기반 기본 UI 컴포넌트 - 그리드, 폼
1. 테넌트 셀프서비스 매시업


# e-shop 서비스들의 데이터베이스 멀티테넌시화

e-shop 서비스를 구성하는 세부 마이크로 서비스들인 Customer 와 Order 서비스 중에서 우선 Order 서비스에만 멀티테넌시 데이터베이스 처리 기능을 추가해보자. 다음과 같은 설정 하나만으로 멀티테넌시가 지원된다:

```java

public interface OrderRepository extends MultitenantRepository<Order, Long> {
}

public interface ItemRepository extends MultitenantRepository<Item, String> {
}

```
** MultitenantRepository 가 활성화되려면 다음의 설정도 추가적으로 확인해야 한다:

* Application.java 의 @EnableJpaRepsitories(repositoryBaseClass) 설정 그리고 Metaworks4BaseApplication 을 상속할 것.
```
@EnableJpaRepositories(repositoryBaseClass = MultitenantRepositoryImpl.class, basePackageClasses = {Order.class, Customer.class})

public class Application extends Metaworks4BaseApplication {
}
```

* WebConfig.java 를 둘 것. 
```
@EnableWebMvc
@Configuration
public class WebConfig extends Metaworks4WebConfig{
    @Override
    protected Storage storage() {
        return new LocalFileStorage();
    }
}
```

* Token 인증 필터를 설치 할 것:
token 인증 필터는 테넌트 유저의 인증과 함께 어느 테넌트 소속인지를 확인하는 중요한 역할을 한다. 따라서 꼭 토큰 필터가 설치 되었는지 확인한다:

```
@EnableWebMvc
@Configuration
public class WebConfig extends Metaworks4WebConfig{
    @Override
    protected Storage storage() {
        return new LocalFileStorage();
    }

    @Bean
    public TenantAwareFilter tenantAwareFilter(){
        TenantAwareFilter tenantAwareFilter = new TenantAwareFilter();
        tenantAwareFilter.setAllowAnonymousTenant(true);

        return tenantAwareFilter;
    }
}

```
* 테스트를 위한 AnonymousTenant 를 true 로 두었다. 테스트 마다 header 에 access_token 을 줘서 테스트를 해야 하기 때문에 개발 동안에는 token 없이도 테스트를 가능하게 해준다. 물론, 멀티테넌시를 테스트해야 할때는 access_token을 반드시 줘야만 오류가 생기지 않는다.

# 테스트
```

```