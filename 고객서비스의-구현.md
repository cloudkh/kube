# 고객서비스의 구현

고객정보 서비스는 앞서 주문/재고 서비스를 신청하는 고객에 대한 정보를 저장하고 상품 구매시 포인트가 쌓이도록 포인트 정보를 관리할 수 있어야 한다.

또한 주문/재고 서비스와는 관리팀이 달라서, 분리된 다른 마이크로 서비스로 관리 주체를 분리하고지 한다.

따라서, 다음과 같은 설계 이슈가 존재한다:

1. 주문을 요청한 주문자 정보(Customer)와 주문정보(Order)가 HATEOAS relation 으로 연결되어야 함.
1. 주문이 벌어지는 마이크로 서비스는 주문서비스이므로, 주문서비스에서 고객 서비스가 호출되어 고객의 포인트에 합산되어야 한다. (이때 데이터 정합성 / 트랜잭션 이슈가 있을 수도 있다) 

# 고객 서비스 도메인 클래스 정의

```java
@Entity
public class Customer {

    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Long id;
    private String firstName;
    private String lastName;

    protected Customer() {}

    public Customer(String firstName, String lastName) {
        this.firstName = firstName;
        this.lastName = lastName;
    }

	public Long getId() {
		return id;
	}

	public String getFirstName() {
		return firstName;
	}

	public String getLastName() {
		return lastName;
	}
}
```

# 고객 서비스 Repository 정의

```java
public interface CustomerRepository extends PagingAndSortingRepository<Customer, Long> {

    List<Customer> findByLastName(String lastName);
}

```

# 다른 마이크로서비스간의 엔티티 조합 

이때 고객 Entity 클래스는 주문서비스와 참조가 벌어지는 Bounded Context Class 가 된다. 그러니까, 주문서비스에 Relation을 형성하려면, 주문서비스와 공통으로 참조할 수 있는 영역에 Customer entity 가 존재해야 한다. 따라서 두 프로젝트가 같이 참조 가능한 공통 참조 프로젝트가 존재해야 한다.

Gitlab 에서 bounded-context 라고 하는 신규 프로젝트를 생성하고, 이 프로젝트를 maven 을 통하여 양 프로젝트에 참조가능하도록 설정한다:

그런후에 Order.java 에 Customer 를 @ManyToOne으로 연결한다. (하나의 고객은 여러 주문을 할 것이다)

그러나 중요한 것은, 두개의 클래스가 관계성으로 연결되어 있으나, Order 정보는 주문 마이크로 서비스의 데이터베이스에, Customer 정보는 고객 마이크로 서비스에 각각 격리되어 저장관리 될 것이다. 

# 서비스의 기동

앞서 주문서비스와 마찬가지로 Spring-boot:run 명령이나 IDE 설정으로 서비스를 기동한다. 이때는 기존 주문서비스와 다른 포트로 기동시킨다: (서비스를 OCE 엔진에 곧바로 올린 경우라면, 그냥 해당 route 로 접속한다)
```
mvn spring-boot:run -Dserver.port=8081
```
그런 후, 고객을 등록한다:
```
http localhost:8081/customer firstName="jinyoung" lastName="jang" point=0
```

해당 고객으로 주문을 한다:
```
http ....
```

두개의 서비스는 별도의 데이터베이스에 데이터가 적재되지만, url 링크를 통하여 데이터를 탐색할 수 있다. 그런데 자세히 url 을 보면 문제가 드러난다:

연결된 데이터의 host 주소가 다른 것이 문제다. 이를 해결하려면, 하나의 서버에 연결된 것 처럼 만들어주어야 한다. 이를 위하여 API Proxy (Zuul) 이 필요하다.

* Next: API Gateway 를 통하여 URL 공통화 처리