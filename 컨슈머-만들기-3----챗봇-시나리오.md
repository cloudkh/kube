# 챗봇 시나리오와 챗봇 프로세스 개요
본 시나리오는 [해당 페이지](http://front-end.pas-mini.io/) 에서 진행되며 해당 페이지 로그인 계정은
jyjang@uengine.org // test 이다.

# 프로세스 구현
1. Message Start Event 의 설정

    1. 로그인 후, 좌측상단의 메뉴를 열어서 Definition으로 넘어간다. 현재 기본 예제 프로세스들이 있다.
우측 상단 (+) 버튼에서 나오는 하위 메뉴중 가장 오른쪽(트리모양)을 선택하면 프로세스를 작성하는 페이지로 넘어간다.
![image](https://user-images.githubusercontent.com/16382067/35142759-a12dc326-fd42-11e7-9df6-defac509d04b.png)

    1. Start Event에서 스패너모양의 버튼을 클릭하면 Message Start Event로 전환 할 수 있다.
![image](https://user-images.githubusercontent.com/16382067/35142950-445a5474-fd43-11e7-9e1b-30a2fc598723.png)

    1. 전환 후, 더블클릭하여 Properties창을 열어보면 관련 속성값이 나온다.
![image](https://user-images.githubusercontent.com/16382067/35143047-96e92a94-fd43-11e7-91d9-01c76c90d914.png)
Service Path와, Correlation Key의 값이 비어 있는데, 이것을 각각 message, user_key로 넣어준다.

message, user_key가 들어오면 이벤트가 실행이 된다.

1. Send Task 를 이용한 응답 설정
    1. 위에서 작성한 Message Start Event를 클릭한 뒤, 사각형 버튼을 누르면 Task를 연결하여 추가할 수 있다.
![image](https://user-images.githubusercontent.com/16382067/35143390-b8756654-fd44-11e7-81a3-48145fe43461.png)

    1. 위에서 Start Event를 수정했듯이, Task도 같은 방법으로 Send Task로 바꾸어 준다.
    1. Send Task의 Properties를 수정한다.
    1. Send Task의 Properties의 작성을 위해서 상단의 Process Variable을 선택 후, resp라는 변수를 추가해준다. 
        1. 변수 추가는, 추가버튼 선택후, Name과 변수 유형만 설정해주면 된다. (Name: resp, 변수 유형: 문자열)
![image](https://user-images.githubusercontent.com/16382067/35143537-3998096c-fd45-11e7-910b-8d6036532775.png)
    
    1. 변수 추가가 완료 되었으면 결과 입력 변수에는 resp를 작성해주면 된다.
    1. 입력 데이터(JSON/XML) 부분의 작성법은 아래와 같다.
```JSON
{
    "message": {
        "text": "예제입니다"
    }
}

(text다음의 "예제입니다." 부분을 원하는 메시지로 수정하여 작성하면 된다.)
(해당 시나리오에서는 "안녕하세요. 챗봇입니다. \n  계속 진행하실건가요?(숫자로 입력해주세요) \n 1. 네 \n 2. 아니요" 로 작성)
```

위의 작업이 완료되면, 메시지를 보내주면 자동으로 Send Task로 넘어가서 해당 text부분의 메시지를 발송하여 준다.

1. Message Intermedate Cat Event 설정
    1. Send Task에서 Intermediate Event를 추가하여준다.
![image](https://user-images.githubusercontent.com/16382067/35144033-ae4ff6ec-fd46-11e7-8f12-738589021f16.png)
    1. 해당 이벤트도 Message Intermediate Catch Event로 수정하여 준다.
    1. Message Intermediate Catch Event의 Properties를 보면 Message Start Event와 같다.
    1. 한가지 다른 점은 데이터 속성 별 매핑을 해주어야 어떠한 메시지가 들어왔는지 판단하고 이후에 진행할 조건분기에서 분기해줄 수 있다.
    1. Process Variable로 돌아가서, answer라는 변수를 추가해준다.
    1. 데이터 속성 별 매핑에서 매핑추가를 한뒤에 아래와 같이 수정해 준다.
    ![image](https://user-images.githubusercontent.com/16382067/35144654-7947213a-fd48-11e7-8546-4a05f5e6ce11.png)
    1. 아규먼트는 content로 수정해주고 연결 변수를 answer로 수정해주면, 메세지가 들어왔을때, 들어온 메세지가 answer의 변수로 저장이 된다.

1. 조건분기 설정
    1. Message Intermediate Catch Event에서 조건분기를 추가해준다.
![image](https://user-images.githubusercontent.com/16382067/35144730-c327d5ce-fd48-11e7-8a90-393800f3cb8b.png)
    1. 조건분기를 위하여 2개의 SendTask를 연결해준다.
    1. 각각의 SendTask로 연결된 선을 더블클릭하면 해당 선에 관련한 Properties를 설정할 수 있다.
    ![image](https://user-images.githubusercontent.com/16382067/35145274-92ae76c6-fd4a-11e7-9468-7978274410b5.png)
    1. 프로세스 변수에는 이전에 답변받은 값을 저장한 answer로 지정하여 주고, 조건 연산자는 = , 비교 값은 각각의 선에 1과 2로 준다.
    
위까지의 과정을 진행하면, 메세지로 프로세스 시작 -> 자동안내 메세지 -> 답변 -> 조건분기 -> 분기에 맞는 답변 까지 진행이된다.

1. 오류 발생시 Catch Error Event 설정
    1. Catch Error Event는 Intermediate Catch Event의 속성 변경 종류 중에서, Catch Error intermadiate Throw Event로 설정하여 주면 된다. (왼쪽 트리중 2번째에 있는 것으로 생성한다.)
    1. 오류의 발생 가능성이 있는 Task 근처로 이동 후, 더블클릭을 하면 Properties가 나오고 '부착 액티비티 ID'라는 설정 나온다.
    1. 해당 입력란에 오류가 발생 가능성이 있는 Task의 액티비티 ID를 작성을 한 뒤에 Properties창을 닫고, Catch Error Event가 발생 했을 경우 되돌아 갈 곳으로 선을 연결하여 준다. (하단 그림 참조)
![image](https://user-images.githubusercontent.com/16382067/35145607-ce24d1c2-fd4b-11e7-9f36-1ffbbae316f2.png)

# 카카오톡과의 연동
1. 카카오 플러스 친구 등록
    1. [카카오 플러스 친구](https://center-pf.kakao.com/) 좌측의 링크로 가서 카카오 플러스 친구가입을 진행한다.
    1. 로그인 후, 새 플러스 친구를 등록한다.
![image](https://user-images.githubusercontent.com/16382067/35145784-67ed2692-fd4c-11e7-8ad7-61614a607537.png)
    1. 새 플러스 친구 등록이 완료되면, 해당 플러스 친구로 접속 후, 아래와 같이 설정하여준다.
```
관리 -> 상세설정 -> 공개 설정 -> 홈 공개 On / 검색허용 On / 노출 허용 On
```
![image](https://user-images.githubusercontent.com/16382067/35145892-c166a946-fd4c-11e7-941b-85820171233b.png)

2. API 대응 설정
    1. 플러스 친구관리자로 접속 후, 좌측에 스마트채팅이라는 메뉴를 선택하면 FAQ형, API형 2가지가 있는데 API로 진행한다. API형아래 있는 설정하기 버튼을 눌러준다.
![image](https://user-images.githubusercontent.com/16382067/35146273-d7e6004e-fd4d-11e7-9abd-0c26aa2daa49.png)
    1. 앱 등록을 진행한다.
```
앱 이름 : 임의 작성
앱 URL : http://uengine5-router.pas-mini.io/services
앱 설명 : 임의 작성
```
앱 URL에 http://uengine5-router.pas-mini.io/services을 작성 후 API 테스트를 진행하여
```
Required*
keyboard OK
{"type":"text"}
```
라는 메시지가 뜰 경우 정상적으로 진행이 가능하다.

    1. 알림받을 전화번호를 설정 후, 우측 하단의 API형 저장하기 버튼을 클릭하여 저장한다.
    1. 그리고 다시 스마트채팅으로 돌아와서, API형의 아래의 시작하기 버튼을 클릭하여 실행한다.

3. 테스트
    1. 카카오톡에서 개인이 만든 플러스친구를 친구 추가한다.
    1. 친구 추가 후, 테스트메시지를 발송해본뒤 정상적으로 메세지가 발송됐는지 확인해 본다.
![image](https://user-images.githubusercontent.com/16382067/35147062-8e108cac-fd50-11e7-838b-b05a8f09917c.png)